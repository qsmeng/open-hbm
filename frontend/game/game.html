<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>半数黑金 - 游戏页面</title>
    <link href="/static/game/game.css" rel="stylesheet">
</head>
<body>
    <main class="main" id="main">
        <div class="game-area">
            <div class="buttons-area">
                <!-- 左侧 按钮区域 -->
                <h2>生成背景故事</h2>
                <button class="button" onclick="handleAction(generateStory, '生成背景故事')">生成背景故事</button>

                <h2>选择角色</h2>
                <button class="button" onclick="handleAction(generateCharacter, '生成角色')">生成角色</button>
                <div id="story-background"></div>
                <div id="character-info"></div>

                <h2>生成场景</h2>
                <button class="button" onclick="handleAction(generateScene, '生成场景')">生成场景</button>
                <div id="scene-info"></div>

                <h2>选择初始卡片 (最多 3 张)</h2>
                <div class="card-options">
                    <button class="button card-button" id="card-button1" onclick="selectCard('卡片1')">卡片1
                        <div class="card-div" id="card-div1"></div>
                    </button>
                    <button class="button card-button" id="card-button2" onclick="selectCard('卡片2')">卡片2
                        <div class="card-div" id="card-div2"></div>
                    </button>
                    <button class="button card-button" id="card-button3" onclick="selectCard('卡片3')">卡片3
                        <div class="card-div" id="card-div3"></div>
                    </button>
                </div>

                <h2>选择行动</h2>
                <div class="action-options">
                    <button class="button action-button" id="action-button1" onclick="performAction('行动1')">行动1
                        <div class="action-div" id="action-div1"></div>
                    </button>
                    <button class="button action-button" id="action-button2" onclick="performAction('行动2')">行动2
                        <div class="action-div" id="action-div2"></div>
                    </button>
                    <button class="button action-button" id="action-button3" onclick="performAction('行动3')">行动3
                        <div class="action-div" id="action-div3"></div>
                    </button>
                    <button class="button action-button" id="action-button4" onclick="performAction('行动4')">行动4
                        <div class="action-div" id="action-div4"></div>
                    </button>
                </div>
            </div>

            <!-- 右侧 图片区域 -->
            <div class="image-area">
                <img id="action-image" src="/static/images/background.png" alt="抽卡图案">  
                <button id="prevImage" onclick="prevImage()">◀</button>
                <button id="nextImage" onclick="nextImage()">▶</button>
            </div>
        </div>
        <!-- 底部 -->
        <div class="chat-area">
            <div class="chat-messages" id="chat-messages">
                1 <hr>
                2 <hr>
                3 <hr>
                4 <hr>
                5 <hr>
            </div>
            <div class="chatbox">
                <input type="text" id="chat-input" class="chat-input" placeholder="输入消息..." />
                <button class="button chatbox-button" onclick="sendMessage()">发送</button>
            </div>
        </div>
    </main>

    <script>
        const IMAGE_BACKGROUND = '/static/images/background.png';
        const IMAGE_HBM = '/static/images/hbm.png';

        const images = [
            IMAGE_BACKGROUND,
            IMAGE_HBM,
        ];

        let currentIndex = 0;

        function updateImage() {
            const imgElement = document.getElementById('action-image');
            if (imgElement) {
                imgElement.src = images[currentIndex];
            }
        }

        function prevImage() {
            currentIndex = (currentIndex > 0) ? currentIndex - 1 : images.length - 1;
            updateImage();
        }

        function nextImage() {
            currentIndex = (currentIndex < images.length - 1) ? currentIndex + 1 : 0;
            updateImage();
        }

        async function callAPI(url, params = {}) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params),
                });
                if (!response.ok) throw new Error('网络请求失败');
                return await response.json();
            } catch (error) {
                console.error(`API调用失败: ${url}`, error);
                throw error;
            }
        }

        async function generateStory() {
            try {
                const data = await callAPI('/generate_story_background', { role: '玩家', game_progress: '开始' });
                document.getElementById('story-background').innerText = data.story_background;
            } catch (error) {
                console.error('生成背景故事失败:', error);
                document.getElementById('story-background').innerText = '生成背景故事失败，请重试。';
            }
        }

        async function generateCharacter() {
            try {
                const data = await callAPI('/generate_character');
                document.getElementById('character-info').innerText = data.character_info;
            } catch (error) {
                console.error('生成角色失败:', error);
                document.getElementById('character-info').innerText = '生成角色失败，请重试。';
            }
        }

        async function generateScene() {
            try {
                const data = await callAPI('/generate_scene', { role: '玩家', game_progress: '开始' });
                document.getElementById('scene-info').innerText = data.scene_info;
            } catch (error) {
                console.error('生成场景失败:', error);
                document.getElementById('scene-info').innerText = '生成场景失败，请重试。';
            }
        }

        function selectCard(cardId) {
            const cardDiv = document.getElementById(`card-div${cardId}`);
            if (cardDiv.classList.contains('selected')) {
                cardDiv.classList.remove('selected');
            } else {
                cardDiv.classList.add('selected');
            }
        }

        function performAction(actionId) {
            const actionDiv = document.getElementById(`action-div${actionId}`);
            if (actionDiv.classList.contains('selected')) {
                actionDiv.classList.remove('selected');
            } else {
                actionDiv.classList.add('selected');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input').value.trim();
            if (!input) {
                alert('输入不能为空！');
                return;
            }
            try {
                const data = await callAPI('/chat', { message: input });
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML += `<p>${data.message}</p>`;
            } catch (error) {
                alert('发送消息失败，请稍后再试。');
            }
        }

        async function fetchStoryBackground() {
            try {
                const data = await callAPI('/generate_story_background?role=玩家&game_progress=开始');
                document.getElementById('story-background').innerText = data.story_background;
            } catch (error) {
                alert('无法加载故事背景');
            }
        }

        async function fetchGameState() {
            try {
                const data = await callAPI('/game_state');
                document.getElementById('game-state').innerText = data.state;
            } catch (error) {
                alert('无法加载游戏状态');
            }
        }

        async function initializeGame() {
            await fetchStoryBackground();
            await fetchGameState();
        }

        window.onload = initializeGame;

        function resetGame() {
            callAPI('/reset_game', 'POST')
                .then(() => {
                    window.location.reload();
                })
                .catch(error => {
                    alert('重置游戏失败，请稍后再试。');
                });
        }
    </script>
</body>
</html>